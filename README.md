<h1 style="text-align: center">Stegom4a</h1>

<p style="text-align: center">Программа была создана для стеганографии в файлах формата .m4a</p>



<h2 style="text-align: center">Процесс записи</h3>
<p align="center">
    <img src="https://github.com/kib-sources/stego-mp4-link/assets/66170584/c93ec042-ce28-41ac-ac7f-58c74db66bc4" />
</p>
<h3 align="center">Схема преобразования пароля в ключ</h3>

<p align="center">
    <img src="https://user-images.githubusercontent.com/59966999/230738006-980c35d8-f4e1-4d66-9e98-b0b3077e0f3d.png"
</p>

Критерии пароля:

1) Использование символов исключительно из таблицы **ASCII**
2) Длина пароля больше 9 символов

Применяется алгоритм Password-Based Key Derivation Function (**PBKDF2**), использующий алгоритм хеширования **SHA-512**. 
В результате получаем ключ из введённого пароля.


<h3 align="center">Схема шифрования сообщения</h3>

<p align="center">
    <img src="https://user-images.githubusercontent.com/59966999/230738033-f9823780-2221-4196-86a9-19cb22330630.png"/>
</p>

В сообщении должны находиться символы исключительно из таблицы **ASCII**.

Для шифрования сообщения используем симметричный алгоритм блочного шифрования **AES** и кодировку **Base64**. Ключ получаем из прошлого шага. 
На выходе получаем зашифрованное сообщение.

<h3 align="center">Схема использования одноразового блокнота</h3>
<p align="center">
    <img src="https://github.com/kib-sources/stego-mp4-link/assets/66170584/dbee665e-78c2-490a-9ce6-630721b2760d"/>
</p>

Используем сервис **privatty** или **onetimesecret**. Через **Selenium WebDriver** вставляем зашифрованное ранее сообщение в сервис. В результате
получаем ссылку, которую можно использовать _один раз_.


<h3 align ="center">Схема использования сервиса коротких ссылок</h3>

<p align="center">
    <img src="https://user-images.githubusercontent.com/59966999/230738058-3632aacd-ab33-4312-a493-1faeead9fb2f.png"/>
</p>

Используем сервис **goo.su**. Для его использования необходимо получить индивидуальный **API-токен** (https://goo.su/api-doc) и вставить его в файл **.env** 
(пример формата представлен в файле **.env.example**). В результате получаем короткую ссылку, с которой дальше работаем.


<h3 align="center">Схема шифрования короткой ссылки и преобразования её в нибблы</h3>

<p align="center">
    <img src="https://user-images.githubusercontent.com/59966999/230738084-d4a46e3d-0cc5-4db1-a3bc-733841d289a8.png">
</p>

Применяется шифр Вернама для шифрования короткой ссылки. После шифрования преобразуем зашифрованную ссылку 
в **нибблы** (полубайты) с добавлением размера в начало (для возможности дальнейшего чтения из файла). В результате 
получаем список hex-символов.


<h3 align="center">Схема чтения метаданных, внедрение в неё списка нибблов</h3>
<p align="center">
    <img src="https://user-images.githubusercontent.com/59966999/230738143-ce9905af-55e1-44c7-b0d5-befd90d43872.png">
</p>

Считываются метаданные из файла *.m4a, внедряем в её чанки (**mvhd**, **tkhd**) информацию. На выходе получаем
новые метаданные *.m4a файла.


<h3 align="center">Схема записи новых метаданных в файл</h3>

<p align="center">
    <img src="https://user-images.githubusercontent.com/59966999/230738150-25c7ca9b-f198-4d11-918a-67e8991d5d20.png">
</p>

Подменяем старые метаданные на новые, записываем в файл *stego.m4a
___
<p align = "center">В результате имеем файл формата m4a, который содержит зашифрованную ссылку.

<h2 align="center">Схема считывания сообщения.</h2>

<p align="center">
    <img src="https://github.com/kib-sources/stego-mp4-link/assets/66170584/47057f7f-3870-4b99-8347-0f0664a5c5f6">
</p>

<h3 align="center">Получение ключей из паролей</h3>

<p align="center">
    <img src="https://user-images.githubusercontent.com/59966999/230739529-4f0cbd71-8bb8-449b-af8f-d36ca8328a8c.png">
</p>


После того как мы вводим пароль, мы используем его как два ключа. Первый ключ для расшифрования ссылки при помощи шифра вернама ***link_key***,
второй в свою очередь предназначен для дешифровки хэшированного сообщения, ***message_key***.


<h3 align="center">Считывание ссылки с метаданных</h3>

<p align="center">
    <img src="https://user-images.githubusercontent.com/59966999/230739539-88f5ebdc-1539-41c4-8152-b98a997cf32f.png">
</p>
    

Мы считываем файл с зашифрованным сообщением, и находим в нём специальный чанк ***moov*** (метаданные), в котором находится сообщение.

<h3 align="center">Разбор нужных чанков</h3>

<p align="center">
  <img src="https://user-images.githubusercontent.com/59966999/230739544-08717aaa-4169-41ec-97af-0f72c1ae146f.png">
</p>

После считывания данного чанка мы перебираем его до подчанков, в которых и находится сообщение. В каждом чанке находится максимум по 2 символа из ссылки. Размер ссылки от 4-7, поэтому в первом подчанке первым символом мы храним размер ссылки.

- Чанк mvhd:
  - create-date - считываем первые 2 симвова и определяем размер
  - modify-date - считываем вторые 2 символа

- Чанк tkhd
    - track create-date - в третьем чанке может храниться минимум 1 символ. Считываем его в любом случае
    - track modify-date - в четвертом чанке может не быть символов. Чтобы корректно считать ссылку мы проверяем первый символ который является размером ссылки. В случае если цифра больше 6, тогда мы считываем символы в данном чанке, иначе его не открываем.

Собираем сообщение и при помощи словарей(***nibble_ret***) получаем список hex-элементов.

<h3 align="center">Превращение в ссылку</h3>
<p align="center">
  <img src="https://user-images.githubusercontent.com/59966999/230739547-7ef736ad-99ae-4b95-b464-d16ca13dddd8.png">
</p>

После получения списка hex элементов мы при помощи функции ***ex***  переводим список в зашифрованную ссылку. Затем при помощи **link_key** расшифровываем её и получаем готовую ссылку формата ***goo.su/(link)***.

<h3 align="center">Расшифровка сообщения</h3>
<p align="center">
  <img src="https://github.com/kib-sources/stego-mp4-link/assets/66170584/d39a263c-1e24-44b1-8fa0-ffea37f86a96">
</p>

После получения ссылки формата ***goo.su/(link)***, мы переходим по ней на сервис одноразовых сообщений, в которой считываем зашифрованное послание. При помощи **message_key** мы расшифровываем послание и читаем.

### Внимание прочитать один и тот же файл дважды невозможно. Сообщение является одноразовым.

<h2 style="text-align: center">Инструкция к использованию</h2>

<h3 align="center">Запуск проекта</h3>

<p align="center">
  <img src="https://github.com/kib-sources/stego-mp4-link/assets/66170584/770c3006-bd19-45a3-a668-ddd2e34c5514">
</p>

Для запуска проекта, нужно находится в одной папке с проектом. С помощью команды <b><i>cd</i></b> выбираем нужную папку.

<h3 align="center">Флаги</h3>

Для того, чтобы получше узнать программу нужно воспользоваться флагом <b><i>-h</i></b>. Для этого введем следующую команду:

<p align="center">
  <img src="https://github.com/kib-sources/stego-mp4-link/assets/66170584/951d4e55-5617-469c-9cd0-26cee82128e8">
</p>

<ol>
  <li><b>--em, --embed</b> - флаг, подразумевающий одно из действий которое может сделать программа. Данным действием является вкрапление сообщения в файл формата <b>.m4a</b>.</li>
  <li><b>--ex, --extract</b> - флаг, который подразумевает ещё одно действие которое может сделать программа. Данным децствием является считываение сообщения с файла формата <b>.m4a</b>.</li>
  <li><b>-p, --password</b> - вспомогательный флаг который нужен для задания пароля. Пароль должен состоять не менее чем из 9 цифр. Пример использования: <i>"-p PASSWORD123"</i></li>
  <li><b>-m, -massage</b> - вспомогательный флаг который нужен для написания послания. Пример использования: <i>"-m 'Hello world!'"</i>.</li>
  <li><b>-i, --input</b>- вспомогательный флаг который нужен для задания названия файла в который нужно записать сообщение. Пример использования: "-i stego.m4a".</li> 
  <li><b>-o, -output</b> - вспомогательный флаг который нужен для задания названия нового файла в котором уже будет спрятано сообщение из файла. Пример использования: "-o stego_secret.m4a</li>
  <li><b>--env</b> - выводит все переменные окружения.</li>
  <li><b>-n, --name</b> - вспомогательный флаг который подразумевает выбирать сервис одноразовых блокнотов. Использование его необязательно. По умолчанию задан сервис <i>"privatty.com"</i>. Пример использования: <i>"-n onetimesecret"</i></li>
  <li><b>-q, --quiet</b> - включает "тихий" режим. После введения данного флага, процесс программы не будет выводится в терминал.</li>
  <li><b>-d, -debug</b> - включает режим "дебага". После введения данного флага, будет выведен весь процесс программы.</li>
  <li><b>-v, --version</b> - показывает версию программы.</li>
</ol>

<h3 align="center">Примеры использования</h3>

<h4>Процесс записи</h4>
<p align="center">
    <img src="https://github.com/kib-sources/stego-mp4-link/assets/66170584/f58f3f1f-e19f-4fb3-bd45-d403ceedf6bd">
</p>

<h4>Процесс чтения</h4>
<p align="center">
  <img src="https://github.com/kib-sources/stego-mp4-link/assets/66170584/6c0eacb6-ee71-4ea9-948b-527adae6a6a6">
</p>

<h4>Вывод переменных окружения</h4>

<p align="center">
  <img src="https://github.com/kib-sources/stego-mp4-link/assets/66170584/9cc86cb7-264e-4d81-9e40-1d8c5e7c677e">
</p>

<h4>Тихий режим</h4>

<p>
  <img src="https://github.com/kib-sources/stego-mp4-link/assets/66170584/b6103cdf-c9ec-4052-a44f-057d8982c8fa">
</p>

<h4>Режим дебага</h4>

<p>
  <img src="https://github.com/kib-sources/stego-mp4-link/assets/66170584/45b730b6-cc0a-4622-b830-cd32f9343632">
</p>

<h4>Вывод версии</h4>
<p align="center">
  <img src="https://github.com/kib-sources/stego-mp4-link/assets/66170584/a563a3c7-0991-47c6-84e3-b7ae42f282e9">
</p>

---

<h2 align="center">Над проектом работали <a href="https://github.com/yourProgrammist">yourProgrammist</a> и <a href="https://github.com/nurovAm">nurovAm</a> </h2>